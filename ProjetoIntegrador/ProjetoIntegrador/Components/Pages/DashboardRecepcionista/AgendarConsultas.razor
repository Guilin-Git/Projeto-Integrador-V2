@page "/dash-recepcionista/agendarConsultas"
@attribute [Authorize(Roles = "Recepcionista,Administrador")]

@inject ApplicationDbContext DbContext
@inject NavigationManager Navigation
@inject AuthenticationStateProvider AuthProvider
@rendermode InteractiveServer


@using Microsoft.EntityFrameworkCore
@using Microsoft.AspNetCore.Components.Authorization
@using Microsoft.AspNetCore.Authorization
@using ProjetoIntegrador.Models
@using ProjetoIntegrador.Data

<h3 class="mb-4">📅 Agendar ou Remarcar Consulta</h3>

<EditForm Model="agendamento" OnValidSubmit="SalvarAgendamento">
    <DataAnnotationsValidator />
    <ValidationSummary />

    <div class="mb-3">
        <label class="form-label">Paciente</label>
        <InputSelect class="form-select" @bind-Value="agendamento.IdPaciente">
            <option value="">Selecione um paciente</option>
            @foreach (var paciente in pacientes)
            {
                <option value="@paciente.Id">@paciente.Nome</option>
            }
        </InputSelect>
    </div>

    <div class="mb-3">
        <label class="form-label">Médico</label>
        <InputSelect class="form-select" @bind-Value="agendamento.IdMedico">
            <option value="">Selecione um médico</option>
            @foreach (var medico in medicos)
            {
                <option value="@medico.Id">@medico.Nome</option>
            }
        </InputSelect>
    </div>

    @code {
        private string MinAgora => DateTime.Now
        .ToString("yyyy-MM-ddTHH:mm");
    }

    <div class="mb-3">
        <label class="form-label">Data e Hora</label>
        <input type="datetime-local" class="form-control" @bind="dataHoraSelecionada" min="@MinAgora" />
    </div>

    <div class="mb-3">
        <label class="form-label">Status</label>
        <InputSelect class="form-select" @bind-Value="agendamento.Status">
            <option value="">Selecione o status</option>
            <option value="Agendado">Agendado</option>
            <option value="Confirmado">Confirmado</option>
            <option value="Cancelado">Cancelado</option>
        </InputSelect>
    </div>

    <button class="btn btn-success" type="submit">Salvar Consulta</button>
</EditForm>

@if (!string.IsNullOrEmpty(mensagem))
{
    <div class="alert alert-success mt-3">@mensagem</div>
}

@code {
    private Agendamento agendamento = new();
    private List<Usuario> pacientes = new();
    private List<Usuario> medicos = new();
    private string? mensagem;
    private DateTime dataHoraSelecionada = DateTime.Now;

    protected override async Task OnInitializedAsync()
    {
        var roleMedicoId = await DbContext.Roles
            .Where(r => r.Name == "Medico")
            .Select(r => r.Id)
            .FirstOrDefaultAsync();

        var rolePacienteId = await DbContext.Roles
            .Where(r => r.Name == "Paciente")
            .Select(r => r.Id)
            .FirstOrDefaultAsync();

        medicos = await DbContext.Users
            .Where(u => DbContext.UserRoles.Any(ur => ur.UserId == u.Id && ur.RoleId == roleMedicoId))
            .ToListAsync();

        pacientes = await DbContext.Users
            .Where(u => DbContext.UserRoles.Any(ur => ur.UserId == u.Id && ur.RoleId == rolePacienteId))
            .ToListAsync();
    }

    private async Task SalvarAgendamento()
    {
        if (string.IsNullOrWhiteSpace(agendamento.IdPaciente) || string.IsNullOrWhiteSpace(agendamento.IdMedico))
        {
            mensagem = "Selecione um paciente e um médico válidos.";
            return;
        }

        if (dataHoraSelecionada < DateTime.Now)
        {
            mensagem = "Datas passadas não podem ser utilizadas para agendamento.";
            return;
        }

        agendamento.Id = Guid.NewGuid().ToString();
        agendamento.DataHora = dataHoraSelecionada;

        DbContext.Agendamentos.Add(agendamento);
        await DbContext.SaveChangesAsync();

        mensagem = "Consulta agendada com sucesso!";
        agendamento = new();
        dataHoraSelecionada = DateTime.Now;
    }
}
